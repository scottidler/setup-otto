name: Test Action

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  test-platforms:
    name: Test on ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            expected-suffix: linux
          - os: macos-14
            expected-suffix: macos-arm64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup otto (latest)
        uses: ./
        id: otto

      - name: Verify otto is available
        run: |
          otto --version
          echo "Installed version: ${{ steps.otto.outputs.version }}"
          echo "Cache hit: ${{ steps.otto.outputs.cache-hit }}"

      - name: Test otto help
        run: otto --help

  test-specific-version:
    name: Test specific version
    runs-on: ubuntu-latest
    env:
      VERSION: v0.6.5
    steps:
      - uses: actions/checkout@v4

      - name: Setup otto ${{ env.VERSION }}
        uses: ./
        with:
          version: '${{ env.VERSION }}'
        id: otto

      - name: Verify version
        run: |
          otto --version
          echo "Requested: ${{ env.VERSION }}"
          echo "Installed: ${{ steps.otto.outputs.version }}"
          test "otto ${{ env.VERSION }}" = "$(otto --version)"

  test-caching:
    name: Test caching behavior
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: First install (cache miss expected)
        uses: ./
        id: first

      - name: Report first install
        run: |
          echo "Version: ${{ steps.first.outputs.version }}"
          echo "Cache hit: ${{ steps.first.outputs.cache-hit }}"

      - name: Second install (cache hit expected)
        uses: ./
        id: second

      - name: Report second install
        run: |
          echo "Version: ${{ steps.second.outputs.version }}"
          echo "Cache hit: ${{ steps.second.outputs.cache-hit }}"

